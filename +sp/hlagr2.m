%--------------------------------------------------------------------------
%   h = hlagr2(L,x)
%--------------------------------------------------------------------------
%   功能:
%   拉格朗日分数延迟滤波器，拉格朗日插值法实现信号分数延迟
%   (注意,仅适用于实数信号，复数信号需要补偿载波相位)
%--------------------------------------------------------------------------
%   输入：
%           L           FIR滤波器点数(注意滤波器阶数为L-1)
%           x           分数延迟点数
%   输出：  
%           h           滤波器
%--------------------------------------------------------------------------
%   例子：
%   hlagr2(10,0.2)
%   hlagr2(15,1.37)
%   hlagr2(15,[-1 0 1])
%--------------------------------------------------------------------------
function h = hlagr2(L,x)
x = x(:);
N = L-1;                                                                    % 滤波器阶数
M = N/2;                                                                    % 中心值

%滤波器的奇偶判断，得到延迟点数
if (M-round(M))==0 
    D= x + M;                                                               % 整数部分居中
else
    D= x + M - 0.5;
end

%--------------------------------------------------------------------------
%   方法1
%--------------------------------------------------------------------------
% h=ones(N+1,numel(x));
% for idx = 1:numel(D)
%     for n=0:N          
%         n1=n+1;
%         for k=0:N
%             if (k~=n)
%                 h(n1,idx) = h(n1)*(D(idx)-k)/(n-k);
%             end
%         end
%     end
% end
%--------------------------------------------------------------------------
%   方法2
%--------------------------------------------------------------------------
%   构造矩阵 K N
%   矩阵运算各个矩阵元素(D-K)./(N-K) 拉格朗日公式
%   对角线元素替换为1
%   叠乘拍扁
%--------------------------------------------------------------------------
K_matrix = repmat((0:L-1),L,1);     
N_matrix =repmat((0:L-1)',1,L);
for idx = 1:numel(D)
    lagr_matrix = (D(idx)-K_matrix)./(N_matrix-K_matrix);
    lagr_matrix(logical(eye(L))) = 1;
    h(:,idx) = prod(lagr_matrix,2);
end